name: API Dependency Update

on:
  schedule:
    - cron: '0 9 * * 1'  # Lundi 9h
  workflow_dispatch:

jobs:
  update-dependencies:
    name: ğŸ“¦ Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ“¦ Install pip-tools
        run: pip install pip-tools

      - name: ğŸ”„ Update dependencies
        run: |
          # âœ… Si vous avez requirements.in
          if [ -f "requirements.in" ]; then
            pip-compile requirements.in --upgrade
          else
            # Sinon, mettre Ã  jour requirements.txt
            pip list --outdated --format=json | jq -r '.[] | .name' > outdated.txt
            pip install --upgrade -r outdated.txt
            pip freeze > requirements.txt
          fi

      - name: ğŸ§ª Test with new dependencies
        run: |
          pip install -r requirements.txt
          pytest -v || echo "Tests failed, PR will need manual review"

      - name: ğŸ“ Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ğŸ“¦ chore: update Python dependencies'
          title: 'ğŸ“¦ Weekly dependency update'
          body: |
            ğŸ¤– Automated dependency update
            
            **Changes:**
            - Updated Python packages to latest versions
            
            **Action required:**
            - âœ… Review the changes
            - âœ… Verify tests pass
            - âœ… Merge if everything is OK
          branch: chore/dependency-update
          delete-branch: true